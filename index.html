<!DOCTYPE html>
<html>
<head>
  <title>OpenCV.js</title>
  <style src="style.css"></style>
</head>
<body>

  <div>
    <div class="inputoutput">
      <img id="imageSrc" alt="No Image" />
      <div class="caption">imageSrc <input type="file" id="fileInput" name="file" /></div>
    </div>
    <div class="inputoutput">
      <canvas id="canvasOutput" ></canvas>
      <div class="caption">canvasOutput</div>
    </div>
  </div>
  <script type="text/javascript">
  let imgElement = document.getElementById('imageSrc');
  let inputElement = document.getElementById('fileInput');
  inputElement.addEventListener('change', (e) => {
    imgElement.src = URL.createObjectURL(e.target.files[0]);
  }, false);
  imgElement.onload = function() {
    let srcMat = cv.imread(imgElement);
    let grayImg = new cv.Mat();
    cv.cvtColor(srcMat, grayImg, cv.COLOR_RGBA2GRAY, 0);
    
    // função para calcular a hipotenusa de um ponto (x, y)
    function calcHypotenuse(x, y) {
      return Math.sqrt(x*x + y*y);
    }

    function main(image) {
      // obtém as dimensões da imagem
      const rows = image.rows;
      const cols = image.cols;

      // calcula o centro da imagem
      const centerX = cols / 2;
      const centerY = rows / 2;

      // calcula o raio do círculo
      const radius = Math.min(rows, cols) / 2;

      // cria um histograma para armazenar a intensidade dos pixels para cada ângulo
      const histogram = new Array(360).fill(0);

      // percorre todos os pixels da imagem
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          // calcula a hipotenusa do ponto atual
          const hypotenuse = calcHypotenuse(x - centerX, y - centerY);

          // verifica se o ponto está dentro do círculo
          if (hypotenuse <= radius) {
            // calcula o ângulo do ponto atual em relação ao centro da imagem
            const angle = Math.atan2(y - centerY, x - centerX) * 180 / Math.PI;

            // adiciona a intensidade do pixel atual ao histograma para o ângulo correspondente

            let pixel = image.ucharAt(x, y);

            histogram[angle] += 255 - pixel
            //histogram[angle] += image.at(y, x);
            // utilizar o histo
          }
        }
      }

        // encontra o ângulo com a maior intensidade média
        let maxAngle = 0;
        let maxIntensity = 255;
        let maxX, maxY;
        for (let y = 0; y < rows; y++) {
            for (let x = 0; x < cols; x++) {
                const hypotenuse = calcHypotenuse(x - centerX, y - centerY);
                if (hypotenuse <= radius) {
                  const angle = Math.atan2(y - centerY, x - centerX) * 180 / Math.PI;
                  
                  //let pixel2 = srcMat.ucharPtr(x, y);
                  let pixel2 = image.ucharAt(x, y);
                  //console.log('pixel: ',pixel2)
                  let gray = 255 - pixel2;
                  //console.log('R2: ', R2)
                  // os 4 valores tenq ser 0 = preto
                  // o
                  //console.log('angulo: ',angle)
                  //console.log('max: ',maxAngle)
                  //if (angle === maxAngle) {
                  if (gray < maxIntensity) {
                    maxIntensity = gray;
                    console.log('intensidade: ',maxIntensity)
                    maxX = x;
                    maxY = y;
                  
                      //}
                  }
              }
            }
          }
        // encontra o ponto mais distante
        maxPoint = { x: maxX, y: maxY };
        console.log('Ponto mais distante: ', maxPoint);
        let center = new cv.Point(172, 227);
        cv.line(image, center, maxPoint, [0, 0, 255, 255], 2);
        return maxPoint;
    }
    /////////////////////
    main(grayImg)
    cv.imshow('canvasOutput', grayImg);

    grayImg.delete();
    srcMat.delete();
  };
  </script>
  
  <script async src="opencv.js" type="text/javascript"></script>

</body>
</html>